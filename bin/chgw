#!/usr/bin/env python2
'''
change default gw between system gw and vpn gw.
'''
import sys, os, subprocess

def die(msg):
	print "ERROR:", msg
	sys.exit(1)

def getenv(name, default):
	try:
		v = os.environ[name]
	except:
		v = default
	return v.strip()

def net24(ip):
	n = len(ip) - 1
	while n >= 0 and ip[n] != ".":
		n -= 1
	return ip[:n + 1] + "0"

def main():
	VPN_PUB = getenv("VPN_PUB", "47.88.85.167")
	VPN_PRI = getenv("VPN_PRI", "192.168.8.1")
	VPN_NET = getenv("VPN_NET", net24(VPN_PRI))
	NET_ALL = "0.0.0.0"
	
	route = {}
	routeText = subprocess.check_output(["route", "-n"]).strip()
	for line in routeText.splitlines():
		line = line.strip()
		if not line or not line[0].isdigit():
			continue
		row = line.split()
		route[row[0]] = row
	
	if not route.has_key(VPN_NET):
		die("route for VPN_NET: %s not found.\n%s" % (VPN_NET, routeText))
	if not route.has_key(NET_ALL):
		die("route for NET_ALL: %s not found.\n%s" % (NET_ALL, routeText))
	
	vpnIf = route[VPN_NET][-1]
	if route.has_key(VPN_PUB):
		sysRoute = route[VPN_PUB]
	else:
		sysRoute = route[NET_ALL]
	sysGw, sysIf = sysRoute[1], sysRoute[-1]
	if vpnIf == sysIf:
		die("vpnIf and sysIf can't be the same: %s" % vpnIf)
	curIf = route[NET_ALL][-1]
	
	# figure out the real action to do
	action = ""
	if len(sys.argv) > 1:
		action = sys.argv[1]
	if action == "ch":
		if curIf != sysIf:
			action = "sys"
		else:
			action = "vpn"
	elif (action == "sys" and curIf == sysIf) or (action == "vpn" and curIf == vpnIf):
		action = ""
	
	if action != "sys" and action != "vpn":
		if curIf == vpnIf:
			print "current is VPN gw", VPN_PRI, vpnIf
		else:
			print "current is SYS gw", sysGw, sysIf
	else:
		if action == "sys":
			newGw, newIf = sysGw, sysIf
			print "set SYS gw",
		else:
			newGw, newIf = VPN_PRI, vpnIf
			print "set VPN gw",
		print newGw, newIf
			
		if not route.has_key(VPN_PUB):
			subprocess.call(["route", "add", "-host", VPN_PUB, "gw", sysGw, sysIf])	
		subprocess.call(["route", "del", "-net", NET_ALL])
		subprocess.call(["route", "add", "-net", NET_ALL, "gw", newGw, newIf])
		
		if action == "vpn":
			subprocess.call(["bash", "-c", "echo 'nameserver %s' | /sbin/resolvconf -a '%s.chgw'" % (VPN_PRI, vpnIf)])
		elif action == "sys":
			subprocess.call(["/sbin/resolvconf", "-d", "%s.chgw" % vpnIf])
		#subprocess.call(["route", "-n"])

main()
