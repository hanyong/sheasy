#!/bin/bash
set -e

# search up to the directory which contains "${goenv_vendor}"
goenv_vendor="_vendor/"
while test "${PWD}" != "/" && ! ls -d "${goenv_vendor}" >/dev/null 2>&1 ; do
	cd ..
done
# ensure we found "${goenv_vendor}"
ls -d "${goenv_vendor}" >/dev/null 2>&1

goenv_pwd="${PWD}"
goenv_pkg="$(find src/ -type d -exec bash -c 'L=( $(ls -A {}) ) ; test "${#L[@]}" -ne 1 || ! ls -d "{}/${L[0]}/" >/dev/null 2>&1' \; -print | head -n 1)"
: "${goenv_pkg:?}"
test -e self && test "$(readlink self)" = "${goenv_pkg}" || ln -sf "${goenv_pkg}" self
goenv_pkg="${goenv_pkg#src/}"

export GOPATH="${goenv_pwd}":"${goenv_pwd}"/_vendor
test "${#}" -gt 0 || set -- echo "GOPATH=$GOPATH"
cd "${goenv_pwd}/src/${goenv_pkg}" && exec "${@}"
